## 1. 题目介绍

- [题目](https://www.kaggle.com/competitions/equity-post-HCT-survival-predictions)
  - 开发预测模型，提高异基因造血干细胞移植（ HCT ）患者生存率的预测准确性和公平性。HCT 是治疗血液疾病的重要手段，但现有模型常因患者的社会经济地位、种族和地理背景差异存在预测偏差。竞赛要求参赛者构建模型，且确保不同患者群体（ 尤其是种族群体 ）的预测结果公平且精准
- 数据集
  - 由 28.8k 条数据，57 个特征组成，包含患者的临床特征（ 如年龄、疾病阶段 ）、移植相关变量（ 如供体类型 ）及社会人口学信息（ 如种族、地理位置 ）
  - 目标变量是 efs（ 事件无生存状态，1=发生事件，0=删失 ） + efs_time（ 生存时间 ）
    - efs=1 且 efs_time=100 天 → 患者在 100 天时发生事件（ 如死亡、复发 ）
    - efs=0 且 efs_time=200 天 → 患者在 200 天时仍存活，后续数据被删失
- 输出
  - 预测患者个体的风险评分，使得评分与 efs_time 负相关（ 高风险评分 ↔ 短生存时间 ）
- 评估
  - 通过 C-index 评估，仅关注风险评分的相对大小，而非绝对值
- 参考 [思路](https://www.kaggle.com/competitions/equity-post-HCT-survival-predictions/discussion/566528) 和 [代码](https://www.kaggle.com/code/herrahuu/4th-place-solution/notebook)

## 2. 问题分析

- **将问题拆分成两个子任务**
  - 二分类问题，所有没有事件的患者（ EFS=0 ）都应位于列表底部（ 他们之间没有定义顺序 ）
  - 回归问题，对于 EFS = 1，患者按生存时间排序
- **风险评分公式需要平衡种族公平**
  - 最终公式为：$risk\_score = P(event=0) \cdot \frac{2}{s_{0_{group}}} + P(event=1) \cdot (s_{0_{group}} + (1 - s_{0_{group}}) \cdot E[rank\% \mid event=1])$
  - $s_0^{group}$ 为按种族分组的事件未发生概率均值，用于平衡组间公平性
  - $P(event)$ 是第一个子任务得到的预测结果
  - E[rank% | event = 1] 是第一个子任务得到的排序结果

## 3. 数据预处理

- 将训练集与测试集合并，便于统一处理特征
- 处理分类特征
  - 唯一值数量 < 100 的特征当作分类特征
  - 先将填充缺失值为 unknown，然后进行编码成非负整数
- 处理数值特征
  - 对于数值型特征（ 如 age ），若存在缺失值，则生成一个 01 二值列（ 如 age_is_nan ），表示原特征是否缺失，此列被视为分类特征
  - 然后进行标准化（ Z-score ）并用 0 填充缺失值
- 生成聚合特征
  - 按分组特征（ 如 gvhd_proph ）计算目标特征（ 如 age_at_hct ）的均值、标准差，增强群体差异的捕捉能力
- 分离处理后的训练集和测试集

## 4. 模型训练

- 事件概率模型（ 是否发生事件 ）
  - 损失函数：加权二元交叉熵（ BCE ），删失样本权重由 Kaplan-Meier 估计
  - 优化策略：AdamW 优化器 + 权重衰减，使用 EMA（ 指数移动平均 ）平滑参数
- 时间排序模型（ 事件组内生存时间排名 ）
  - 目标转换：将生存时间排名转换为标准正态分布 Z 值，回归后反变换为百分位
  - 损失函数：Huber 损失，对异常值鲁棒
- 预测与集成
  - 多模型集成：融合 TabM、XGBoost、CatBoost、LightGBM 预测结果
  - 模型权重分配
    - 事件概率模型权重：TabM(0.3), XGBoost(0.05), CatBoost(0.35), LightGBM(0.3)
    - 时间排序模型权重：TabM(0.15), XGBoost(0.15), CatBoost(0.55), LightGBM(0.15)
  - 风险评分计算（ 即上面的 风险评分公式 ）
