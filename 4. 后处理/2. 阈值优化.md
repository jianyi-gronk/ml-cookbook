## 1. 阈值优化

- 背景
  - 在二分类模型中，模型通常输出一个概率值，表示样本属于正类的可能性，但部分场景 **要求直接输出最终分类结果（ 是否为正样本 ）**
  - 默认情况下，通常使用 0.5 作为阈值来划分正类和负类，然而 0.5 不一定是最优的，特别是在 数据不平衡 或 不同误分类代价 不同的场景下
    - 数据分布不平衡
      - 当正负样本比例严重失衡时，0.5 阈值可能导致模型过度偏向多数类
    - 业务代价不对称
      - 不同错误类型的代价不同，例如 将患者误诊为健康 和 将健康误诊为患病，代价差异很大
      - 不同正确分类的收益也可能不同
- 定义
  - 阈值优化 是通过 调整分类模型 的决策阈值，使得在特定评估指标或业务目标下达到最优性能
  - 其目标是找到一个阈值，使得模型在验证集上使用该阈值时，能够最大化关心的指标（ 如 F1 分数、利润曲线等 ）

## 2. 解决方法

- 阈值优化 需要在 独立的验证集（ 而非训练集 ）上进行，以防止过拟合

#### 2.1 自动选择阈值

- `sklearn.model_selection.TunedThresholdClassifierCV` 是实现阈值优化的主要工具
  - 它可以包装任何具有 predict_proba 方法或 decision_function 方法的分类器
  - 通过交叉验证自动寻找最优决策阈值，支持优化各种二元分类指标，如 F1 分数、精确率、召回率等
  - 核心参数
    - estimator：需要进行阈值优化的基础分类器实例
    - scoring：要优化的目标指标，默认为 'balanced_accuracy'
      - 字符串：支持的二元分类评分函数名称
      - 可调用对象：自定义评分器函数
    - response_method：模型输出方法
      - 'auto'：自动选择 predict_proba 或 decision_function
      - 'predict_proba'：使用概率预测
      - 'decision_function'：使用决策函数值
    - thresholds：阈值搜索策略，默认为 100
      - 整数：指定要评估的阈值数量
      - 数组：手动指定要评估的阈值数组
    - cv：交叉验证策略，默认为 None（ 即默认使用 5 折 ）
      - 整数：指定折数
      - 浮点数：(0,1) 区间，指定验证集比例
      - 'prefit'：表示基础分类器已经预训练，直接使用提供的验证集优化阈值
    - refit：布尔值，默认为 True
      - True：找到最优阈值后在整个训练集上重新拟合分类器
      - False：不重新拟合，使用交叉验证中的模型
    - store_cv_results：布尔值，默认为 False
      - True：存储交叉验证过程中的所有分数和阈值结果
      - False：不存储交叉验证结果

#### 2.2 手动选择阈值

- 首先需要绘制曲线，找到最优的阈值，常见的用于分析阈值的曲线如下
  - 精确率-召回率 曲线
    - 原理
      - 通过计算 不同阈值 下的 精确率 和 召回率，绘制曲线，然后根据业务目标选择阈值
    - 过程
      - 在验证集上获取模型预测的正类概率
      - 将阈值从 0 到 1 逐步移动，对于每个阈值，计算精确率和召回率
      - 绘制 精确率-召回率 曲线，选择使 F1 分数最大化的阈值，或者根据业务需求选择 精确率 和 召回率 的平衡点
    - 适用场景
      - 数据不平衡的情况，因为 精确率 和 召回率 对少数类更敏感
  - ROC 曲线与 Youden 指数
    - 原理
      - ROC 曲线展示 不同阈值 下的 真阳性率（ TPR ）和 假阳性率（ FPR ）之间权衡关系
      - Youden 指数 = 灵敏度 + 特异度 - 1，最大化 Youden 指数的阈值通常是最佳阈值
    - 过程
      - 计算不同阈值下的真阳性率和假阳性率
      - 绘制 ROC 曲线，计算每个阈值对应的 Youden 指数
      - 选择使 Youden 指数最大的阈值
    - 公式
      $$
      Youden = TPR + (1 - FPR) - 1 = TPR - FPR
      $$
    - 适用场景
      - 正负样本相对平衡，且希望平衡灵敏度和特异度的情况
- 找到最优阈值后，通常使用 `sklearn.model_selection.FixedThresholdClassifier` 来应用该阈值
  - 核心参数
    - 核心参数
    - estimator：基础分类器实例
    - threshold：要设置的固定阈值，默认为 auto
      - 'auto'：自动设置（ predict_proba 默认 0.5，decision_function 默认 0 ）
      - 浮点数：手动指定的阈值
    - pos_label：正类标签，用于处理响应方法的输出
    - response_method：模型输出方法，可选 'predict_proba' 或 'decision_function'
