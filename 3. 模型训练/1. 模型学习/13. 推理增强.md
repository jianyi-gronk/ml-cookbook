## 1. TTA（ Test-Time Augmentation，测试时增强 ）

#### 1.1 基础介绍

- TTA 指的是在模型训练阶段后，对新数据进行推理预测时，可以通过对输入数据进行多种变换，让同一个模型对同一输入的多个视角进行预测
- 类似于 训练时数据增强，区别在于
  - 作用阶段
    - 前者在训练模型阶段，用于训练数据集
    - 而 TTA 在推理预测阶段，作用于测试数据集
  - 是否影响模型
    - 前者会影响模型参数，目的是提升模型泛化
    - 而 TTA 只影响模型预测结果，目的是提升单次预测的稳定性
  - 增强样本
    - 前者每个增强样本都是独立的学习样本，需要注意标签和数据同步变换，保持对其
    - 而 TTA 增强样本和原始样本属于一组，会对每组内样本进行平均、投票等操作，需要注意可能需要逆变换
- 可以理解为
  - 训练时数据增强，相当于给模型看不同角度的猫图片，教他认识猫
  - 测试时数据增强，相当于让模型从多个角度观察一只具体的猫，确认它是猫

#### 1.2 逆变换

- 逆变换是指在测试时增强过程中，将模型对增强后图像的预测结果重新映射回原始图像坐标系的操作，因为不同增强变换后的预测结果处于不同的坐标系中，必须统一到原始图像的坐标系才能进行有效聚合
- 例如 将水平/垂直翻转后的预测结果再次水平/垂直翻转，将缩放后的预测结果缩放回原始尺寸 等
- 并不是所有 TTA 都需要逆变换
  - 语义分割：需要逆变换，因为预测的分割图是像素级标注，必须与原始图像像素一一对应
  - 目标检测：需要逆变换，因为边界框坐标必须映射回原始图像坐标系
  - 图像分类/回归：不需要，因为输出是类别概率或标量值，与空间位置无关

#### 1.3 具体方法

- 常见 TTA 方法
  - 水平翻转，垂直翻转，同时水平垂直翻转
  - 多角度旋转
  - 多尺度缩放
  - 颜色空间变换，如 亮度调整，对比度调整，饱和度调整，色调调整，颜色抖动 等
  - 高级变化，如 添加噪声，模糊/锐化 等
- 升级版用法
  - 先用原始数据进行预测，评估不确定性
  - 因为 TTA 会对性能有一定影响，所以只对高不确定性样本使用更多增强变换
- 数据裁剪
  - 数据裁剪是个特殊方案，使用前需要仔细考虑
  - 例如在 目标检测 场景，裁剪可能会把目标截断，导致模型判断错误，并且数据裁剪的逆变换复杂，单纯填充会缺失细节
  - 如果仍然需要使用数据裁剪，可以考虑使用重叠裁剪，确保每个区域被多次覆盖

## 2. MC Dropout（ 蒙特卡洛 dropout ）

- 核心是 利用模型自身的随机性进行不确定性估计
- 需要在推理阶段保持 Dropout 激活，进行多次前向传播，通过预测结果的方差来估计不确定性，进行多次预测后进行平均、投票等操作
- 实现简单，只需在推理时保持模型为 train() 模式，但存在要求
  - 前提模型有 Dropout 层
  - train 模式下 BN 层行为与 eval 不同，通常将 BN 层单独保留为 eval 模式，其他层设置成 train 模式
