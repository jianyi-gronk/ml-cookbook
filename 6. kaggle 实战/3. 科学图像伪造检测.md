## 1. 题目介绍

- 题目：[科学图像伪造检测](https://www.kaggle.com/competitions/recodai-luc-scientific-image-forgery-detection)
- 数据集：基于从 2,000 多篇撤稿论文中提取的数百个已确认伪造的图像构建
  - train_images：训练图像，分为 authentic（ 真实 ）和 forged（ 伪造 ）子文件夹
  - train_masks：训练集掩码标注，部分图像有多个重复区域因此对应多个掩码
  - supplemental_images：比赛启动后提供的额外训练图像
  - supplemental_masks：额外训练图像的掩码标注
  - test_images：测试集图像
- 特征
  - 图像类型：生物医学研究图像，包括显微镜图像、凝胶电泳图、图表等
  - 图像格式：通常为 PNG、JPEG、TIFF 等格式
  - 伪造类型：复制移动伪造，即图像中的某个区域被复制并粘贴到同一图像的另一位置
  - 伪造复杂性：可能经过旋转、缩放、颜色调整、模糊等后处理操作
- 目标变量
  - 对于测试图像：需要判断是 "authentic" 还是 "forged"
  - 对于伪造图像：需要输出伪造区域的二值掩码（ RLE 编码格式 ）
- 评估
  - 使用 F1 分数的变体进行评估，结合了图像级别检测准确率和像素级别分割精度

## 2. 参考思路

- 基于 [baseline](https://www.kaggle.com/code/hossam82/scientific-image-detection-cnn-0-325?scriptVersionId=290331285) 修改，流程 和 大部分步骤 没有改动
- 基于 DINOv2 + ELA 的推理方案，核心是利用预训练视觉 Transformer 和误差水平分析技术

#### 2.1 数据预处理

- 图像尺寸统一
  - 将所有图像调整为 518×518 像素（ DINOv2 的标准输入尺寸 ）
- 颜色空间转换
  - 确保所有图像为 RGB 三通道格式
- 无损格式检测
  - 检查 PNG/TIFF 图像是否原本是 JPEG 格式（ 通过检测 8×8 块状伪影 ）
  - 如果检测到隐藏的 JPEG 压缩痕迹，则使用 ELA 分析更有效

#### 2.2 模型架构

- 编码器：DINOv2 Vision Transformer
  - 使用自监督预训练权重，具有强大的图像理解能力
  - 编码器完全冻结，不进行微调，保持预训练特征
- 解码器：轻量级 CNN 解码器（ 3 层卷积上采样 ）
  - 输入：DINOv2 提取的 37×37 特征图
  - 输出：518×518 的伪造概率图
- ELA 集成：误差水平分析作为辅助检测手段
  - 原理：通过 JPEG 重压缩揭示不同区域的压缩历史差异
  - 实现：原始图像 → JPEG 重压缩（ 质量 90 ）→ 像素差异计算 → 热图生成

#### 2.3 推理流程

- 特征提取：DINOv2 提取图像的全局和局部特征
- 概率图生成：解码器将特征转换为伪造概率图
- 测试时增强（ TTA ）
  - 原始图像 + 水平翻转 + 垂直翻转
  - 对每个增强版本进行预测，然后逆变换并平均
- ELA 增强预测
  - RGB 概率图（ 70% 权重 ）
  - ELA 图像预测概率图（ ELA_WEIGHT × 70% 权重 ）
  - ELA 热图直接信号（ ELA_WEIGHT × 30% 权重 ）
- 自适应后处理
  - Sobel 梯度增强边界（ α = 0.45 ）
  - 基于均值+标准差的自适应阈值
  - 形态学操作（ 闭运算+开运算 ）平滑掩码
- 决策逻辑：
  - 如果掩码面积 < AREA_THR（ 200 像素 ）或掩码内平均概率 < MEAN_THR（ 0.22 ），则判断为 "authentic"
  - 否则判断为 "forged"，并生成 RLE 编码掩码

## 3. 核心改进方向

- 添加 tta 策略
  - 添加轻微旋转（ 15 度 ）
  - ~~增加尺度变换预测（ 0.9 倍 ）【 会导致劣化 】~~
  - ~~尝试融合 tta 预测时进行加权【 会导致劣化 】~~
- 添加 ensemble 投票机制
  - 选择分 6 个开源方案，将其中最高的方案作为 baseline 方案
  - 当 baseline 的预测为 authentic 时，如果其他 5 个方案中至少有 4 个认为是 forged，则改为判断 forged
  - ~~当 baseline 的预测为 forged 时，如果其他 5 个方案中至少有 4 个认为是 authentic，则改为判断 authentic【 会导致劣化 】~~
